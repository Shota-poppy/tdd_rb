<!DOCTYPE html>
<html lang="ja">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />

    <title>テスト駆動開発から始めるRuby入門</title>
  </head>
  <body>
    <!-- ヘッダー -->
    <header class="py-4"></header>
    <!-- /ヘッダー -->
    <div class="container text-center">
      <h1>テスト駆動開発から始める</h1>
      <h1>Ruby入門</h1>
    </div>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-md navbar-dark bg-dark stick-top">
      <!-- サブコンポーネント -->
      <div class="container">
        <a href="index.html" class="navbar-brand">TDDRuby</a>
        <!-- 切り替えボタン -->
        <button
          class="navbar-toggler"
          type="button"
          data-toggle="collapse"
          data-target="#navbar-content"
          aria-controls="navbar-content"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <!-- ナビゲーション -->
        <div class="collapse navbar-collapse" id="navbar-content">
          <!-- ナビゲーションメニュー -->
          <!-- 左側メニュー: トップページの各コンテンツへのリンク -->
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a href="#" class="nav-link"
                >Top <span class="sr-only">(current)</span></a
              >
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link">About</a>
            </li>
            <li class="nav-item dropdown">
              <a
                href="#"
                class="nav-link dropdown-toggle"
                id="navbarDropdown"
                role="button"
                data-toggle="dropdown"
                aria-hhaspopup="true"
                aria-expanded="false"
              >
                Contents
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                <a href="#" class="dropdown-item">FizzBuzz</a>
              </div>
            </li>
          </ul>
          <!-- /ナビゲーションメニュー -->
        </div>
      </div>
      <!-- サブコンポーネント -->
    </nav>
    <!-- メイン -->
    <main>
      <!-- コンテンツ01 -->
      <div id="app"></div>
      <!-- /コンテンツ01 -->
    </main>
    <!-- /メイン -->
    <!-- フッター -->
    <footer class="py-4 bg-dark text-light">
      <div class="container text-center">
        <!-- ナビゲーション -->
        <ul class="nav justify-content-center mb-3">
          <li class="nav-item">
            <a href="#" class="nav-link">Top</a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">About</a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">Contents</a>
          </li>
        </ul>
        <!-- /ナビゲーション -->
        <p>
          <small>Copyright &copy;2019 HiroshiamARC, All Rights Reserved.</small>
        </p>
      </div>
    </footer>
    <!-- /フッター -->
    <div id="dev">
      <!-- Optional JavaScript -->
      <!-- jQuery first, then Popper.js, then Bootstrap JS -->
      <script
        src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"
      ></script>
      <script
        src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"
      ></script>
      <script
        src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"
      ></script>
      <!-- PapaParse -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.js"></script>

      <!-- nanoSQL2 -->
      <!-- ES6 Only (Faster & Smaller) -->
      <script
        src="https://cdn.jsdelivr.net/npm/@nano-sql/core@2.3.7/dist/nano-sql.min.js"
        integrity="sha256-W1pVgKda7GC4fwXqq9jfOrssBDJJXZqck+ultRPVzmc="
        crossorigin="anonymous"
      ></script>
      <!-- ES5 (Internet Explorer/Old Browser Support) -->
      <!-- Promise must be polyfilled as well -->
      <script
        src="https://cdn.jsdelivr.net/npm/@nano-sql/core@2.3.7/dist/nano-sql.min.es5.js"
        integrity="sha256-1t9VlpFUgHaxlLQy6HM9ROQvTiuUv2M12Fp1oTh3+yg="
        crossorigin="anonymous"
      ></script>

      <!-- markdown -->
      <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

      <!-- PluntUML -->
      <!--  taken from https://github.com/johan/js-deflate -->
      <script src="./lib/rawdeflate.js"></script>

      <!-- mocha, chai -->
      <script src="https://cdn.rawgit.com/mochajs/mocha/2.2.5/mocha.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.2.0/chai.min.js"></script>
      <script>
        const dev = document.querySelector("#app");
        if (dev !== null) {
          dev.innerHTML = `
          <div class="container">
            <h1>FizzBuzz</h1>
              <div class="py-3">
              <div id="mocha"></div>
            <div class="row p-3">
              <div id="spec"></div>
            </div>
            <h2>クラス図</h2>
            <div class="row p-3">
              <img id="class-im"
              src=http://www.plantuml.com/plantuml/img/SyfFKj2rKt3CoKnELR1Io4ZDoSa70000>
            </div>
            <h2>アプリケーション</h2>
              <div id="app-fizz-buzz"></div>
            </div>
          </div> `;
        }
      </script>

      <script>
        mocha.setup("tdd");
        const assert = chai.assert;
        suite("FizzBuzzServiceTest", () => {
          suite("GenerateApiService", () => {
            test("3を渡したらJSONオブジェクトを返す", () => {
              return generate(3).then(data => {
                assert.deepEqual({ number: 3, value: "Fizz" }, data);
              });
            });

            test("5を渡したらJSONオブジェクトを返す", () => {
              return generate(5).then(data => {
                assert.deepEqual({ number: 5, value: "Buzz" }, data);
              });
            });

            test("15を渡したらJSONオブジェクトを返す", () => {
              return generate(15).then(data => {
                assert.deepEqual({ number: 15, value: "FizzBuzz" }, data);
              });
            });
          });

          suite("GenerateListApiService", () => {
            suite("タイプ1の場合", () => {
              test("100件のJSONオブジェクトを返す", () => {
                return generateList(1).then(json => {
                  assert.equal(100, json.data.length);
                });
              });

              test("最初の値は1", () => {
                return generateList(1).then(json => {
                  assert.equal("1", json.data[0]);
                });
              });

              test("最後の値はBuzz", () => {
                return generateList(1).then(json => {
                  assert.equal("Buzz", json.data[99]);
                });
              });

              test("14番目の値はFizzBuzz", () => {
                return generateList(1).then(json => {
                  assert.equal("FizzBuzz", json.data[14]);
                });
              });
            });

            suite("タイプ2の場合", () => {
              test("最初の値は1", () => {
                return generateList(2).then(json => {
                  assert.equal("1", json.data[0]);
                });
              });

              test("最後の値は100", () => {
                return generateList(2).then(json => {
                  assert.equal("100", json.data[99]);
                });
              });

              test("14番目の値は15", () => {
                return generateList(2).then(json => {
                  assert.equal("15", json.data[14]);
                });
              });
            });

            suite("タイプ3の場合", () => {
              test("最初の値は1", () => {
                return generateList(3).then(json => {
                  assert.equal("1", json.data[0]);
                });
              });

              test("最後の値は100", () => {
                return generateList(3).then(json => {
                  assert.equal("100", json.data[99]);
                });
              });

              test("14番目の値はFizzBuzz", () => {
                return generateList(3).then(json => {
                  assert.equal("FizzBuzz", json.data[14]);
                });
              });
            });
          });
        });

        function generate(number) {
          return new Promise((resolve, reject) => {
            fetch(`https://tddrb.k2works.now.sh/api/generate?number=${number}`)
              .then(response => {
                return response.json();
              })
              .then(json => {
                console.log(JSON.stringify(json));
                resolve(json);
              })
              .catch(err => {
                console.log(err);
                reject(err);
              });
          });
        }

        function generateList(type) {
          return new Promise((resolve, reject) => {
            fetch(
              `https://tddrb.k2works.now.sh/api/generate_list?type=${type}&number=100`
            )
              .then(response => {
                return response.json();
              })
              .then(json => {
                console.log(JSON.stringify(json));
                resolve(json);
              })
              .catch(err => {
                console.log(err);
                reject(err);
              });
          });
        }

        class FizzBuzzView {
          constructor() {
            this._counterComponent = new FizzBuzzCounterComponent();
            this._tableComponent = new FizzBuzzTableComponent();
          }

          render() {
              const result = `
              <div class="py-3">
                <section id="menu">
                  <div class="container">
                    <div id="app__message"></div>
                    <div class="nav nav-tabs" id="tab-menus" role="tablist">
                      <a
                        aria-controls="panel-menu01"
                        aria-selected="true"
                        class="nav-item nav-link active"
                        data-toggle="tab"
                        href="#panel-menu01"
                        id="tab-menu01"
                        role="tab"
                        >Counter</a
                      >
                      <a
                        aria-controls="panel-menu02"
                        aria-selected="false"
                        class="nav-item nav-link"
                        data-toggle="tab"
                        href="#panel-menu02"
                        id="tab-menu02"
                        role="tab"
                        >Table</a
                      >
                    </div>

                    <div class="tab-content" id="panel-menus">
                      <div
                        aria-labelledby="tab-menu01"
                        class="tab-pane fade show active border border-top-0 jumbotron"
                        id="panel-menu01"
                        role="tabpanel"
                      >
                        <div id="app__counter" class="row d-flex align-items-center">
                        </div>
                      </div>
                      <div
                        aria-labelledby="tab-menu02"
                        class="tab-pane fade border border-top-0"
                        id="panel-menu02"
                        role="tabpanel"
                      >
                        <dvi class="row p-3">
                          <div id="app__table" class="col-md-12 order-md-2">
                          </div>
                        </dvi>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
            `;

              document.querySelector("#app-fizz-buzz").innerHTML = result;
              this._counterComponent.render();
              this._tableComponent.render();
          }
        }

        class FizzBuzzCounterComponent {
          constructor() {
            this._counter = 0;
            this._value = "FizzBuzz";
          }

          incrementEvent(e) {
            this._counter += 1;
            generate(this._counter).then(data => {
              this._value = data.value;
              this.render();
            });
          }

          decrementEvent(e) {
            this._counter === 0 ? (this._counter = 0) : (this._counter -= 1);
            generate(this._counter).then(data => {
              this._value = data.value;
              this.render();
            });
          }

          render() {
            const counter = `
              <div class="col-md-1">
                <button class="btn btn-primary" id="decrement">
                  -
                </button>
              </div>
              <div class="col-md-10">
                <h1 class="display-1 text-center">${this._value}</h1>
              </div>
              <div class="col-md-1">
                <button class="btn btn-primary" id="increment">
                  +
                </button>
              </div>
            `;

            document.querySelector("#app__counter").innerHTML = counter;
            document
              .querySelector("#increment")
              .addEventListener("click", this.incrementEvent.bind(this));
            document
              .querySelector("#decrement")
              .addEventListener("click", this.decrementEvent.bind(this));
          }
        }

        class FizzBuzzTableComponent {
          constructor() {
            this._list = [];
            this._type = 1;
          }

          selectEvent(e) {
            this._type = e.target.value;
            this.render();
          }

          render() {
            generateList(this._type).then(json => {
              this._list = json.data;

              const result = (() => {
                const select = (() => {
                  const type1 = `<option value="1">タイプ1</option>`;
                  const type2 =
                    this._type === "2"
                      ? `<option value="2" selected>タイプ2</option>`
                      : `<option value="2">タイプ2</option>`;
                  const type3 =
                    this._type === "3"
                      ? `<option value="3" selected>タイプ3</option>`
                      : `<option value="3">タイプ3</option>`;

                  return `
                    <select
                      name="type"
                      id="app__select--type"
                      class="browser-default custom-select"
                    >
                      ${type1}
                      ${type2}
                      ${type3}
                    </select>
              `;
                })();

                const header = (() => {
                  // 0から始まるので最初の値を削除する
                  const th = [...Array(11).keys()]
                    .slice(1)
                    .map(i => `<th>${i}</th>`)
                    .join("");

                  return `
                  <thead>
                    <tr>
                      ${th}
                    </tr>
                  </thead>
              `;
                })();

                const body = (() => {
                  const td = (() => {
                    let row = [];
                    let column = [];
                    this._list.forEach((v, k) => {
                      column.push(`<td>${v}</td>`);

                      if ((k + 1) % 10 === 0) {
                        row.push(column.join(""));
                        column = [];
                      }
                    });

                    return row;
                  })();

                  return `
                <tbody>
                  <tr>${td[0]}</tr>
                  <tr>${td[1]}</tr>
                  <tr>${td[2]}</tr>
                  <tr>${td[3]}</tr>
                  <tr>${td[4]}</tr>
                  <tr>${td[5]}</tr>
                  <tr>${td[6]}</tr>
                  <tr>${td[7]}</tr>
                  <tr>${td[8]}</tr>
                  <tr>${td[9]}</tr>
                </tbody>
              `;
                })();

                return `
                <dvi class="row p-3">
                  <div class="col-md-12 order-md-2">
                    <div id="app__select">
                      ${select}
                    </div>
                    <div
                      class="table-responsive"
                      id="app__table-contents"
                    >
                      <table class="table table-striped">
                        ${header}
                        ${body}
                      </table>
                    </div>
                  </div>
                </dvi>
            `;
              })();

              document.querySelector("#app__table").innerHTML = result;
              document
                .querySelector("#app__select--type")
                .addEventListener("change", this.selectEvent.bind(this));
            });
          }
        }

        const view = new FizzBuzzView();
        view.render();
      </script>

      <script>
        const spec = document.getElementById("spec");
        if (spec) {
          // eslint-disable-next-line no-undef
          spec.innerHTML = marked(
            `
## 仕様
1から100までを１件ずつ画面に表示できる。

1から100まで表示された内容を表示できる。

## ToDoリスト
- [ ] カウンター画面
  - [x] 画面イメージを作る
  - [x] APIサービスを作る
  - [ ] APIサービスと連携するクライアントサービスを作る
    - [x] 正常系を実装する
    - [ ] 例外系を実装する
  - [x] UIを作る
  - [x] UIとクライアントサービスを連携する
- [ ] 一覧表示画面
  - [x] 画面イメージを作る
  - [x] APIサービスを作る
  - [ ] APIサービスと連携するクライアントサービスを作る
    - [x] 正常系を実装する
    - [ ] 例外系を実装する
  - [x] UIを作る
  - [x] UIとクライアントサービスを連携する
        `
          );
        }
      </script>
      <script>
        /* eslint-disable */
        const classDiagram = (() => {
          const inputId = "class-diagram-input";
          const outputId = "class-im";
          const source = `
package Presentation {
  class FizzBuzzView {
    _counterComponent
    _tableComponent
    render()
  }

  class FizzBuzzCounterComponent {
    _conter
    _value
    incrementEvent()
    decrementEvent()
    render()
  }

  class FizzBuzzTableComponent {
    _list
    _type
    changeEvent()
    render()
  }
}

package Application {
  package Service {
    class FizzBuzzService {
    }

    interface FizzBuzzCommand {
    }

    class FizzBuzzValueCommand {
    }

    class FizzBuzzListCommand {
    }
  }
}

package Domain {
    package Model {
      class FizzBuzzValue {
      }

      class FizzBuzzList {
      }
    }

    package Type {
      class FizzBuzzType {
      }

      class FizzBuzzType01 {
      }

      class FizzBuzzType02 {
      }

      class FizzBuzzType03 {
      }
    }
}
FizzBuzzCommand <|-- FizzBuzzValueCommand
FizzBuzzCommand <|-- FizzBuzzListCommand
FizzBuzzCommand *- FizzBuzzType
FizzBuzzType <|-- FizzBuzzType01
FizzBuzzType <|-- FizzBuzzType02
FizzBuzzType <|-- FizzBuzzType03
FizzBuzzService -> FizzBuzzCommand
FizzBuzzService <--- FizzBuzzView
FizzBuzzView *- FizzBuzzCounterComponent
FizzBuzzTableComponent -* FizzBuzzView
`;
          compress(source, outputId);
        })();
        function encode64(data) {
          r = "";
          for (i = 0; i < data.length; i += 3) {
            if (i + 2 == data.length) {
              r += append3bytes(data.charCodeAt(i), data.charCodeAt(i + 1), 0);
            } else if (i + 1 == data.length) {
              r += append3bytes(data.charCodeAt(i), 0, 0);
            } else {
              r += append3bytes(
                data.charCodeAt(i),
                data.charCodeAt(i + 1),
                data.charCodeAt(i + 2)
              );
            }
          }
          return r;
        }
        function append3bytes(b1, b2, b3) {
          c1 = b1 >> 2;
          c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
          c3 = ((b2 & 0xf) << 2) | (b3 >> 6);
          c4 = b3 & 0x3f;
          r = "";
          r += encode6bit(c1 & 0x3f);
          r += encode6bit(c2 & 0x3f);
          r += encode6bit(c3 & 0x3f);
          r += encode6bit(c4 & 0x3f);
          return r;
        }
        function encode6bit(b) {
          if (b < 10) {
            return String.fromCharCode(48 + b);
          }
          b -= 10;
          if (b < 26) {
            return String.fromCharCode(65 + b);
          }
          b -= 26;
          if (b < 26) {
            return String.fromCharCode(97 + b);
          }
          b -= 26;
          if (b == 0) {
            return "-";
          }
          if (b == 1) {
            return "_";
          }
          return "?";
        }
        var deflater = window.SharedWorker && new SharedWorker("rawdeflate.js");
        if (deflater) {
          deflater.port.addEventListener("message", done_deflating, false);
          deflater.port.start();
        } else if (window.Worker) {
          deflater = new Worker("rawdeflate.js");
          deflater.onmessage = done_deflating;
        }
        function done_deflating(e, id) {
          document.getElementById(id).src =
            "http://www.plantuml.com/plantuml/img/" + encode64(e.data);
        }
        function compress(s, id) {
          //UTF8
          s = unescape(encodeURIComponent(s));
          if (deflater) {
            if (deflater.port && deflater.port.postMessage) {
              deflater.port.postMessage(s);
            } else {
              deflater.postMessage(s);
            }
          } else {
            setTimeout(function() {
              done_deflating({ data: deflate(s) }, id);
            }, 100);
          }
        }
      </script>
      <script>
        mocha.globals(["jQuery"]);
        mocha.run();
      </script>
    </div>
  </body>
</html>
